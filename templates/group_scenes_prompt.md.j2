{{ system_reference }}
{{ setting_reference }}

---

## üéØ Task: Group Locations into Narrative Scenes

You are converting a D&D 5E adventure for *Swords of the Serpentine*.
Your goal is to take a list of extracted individual locations and group them into cohesive narrative "scenes." Each scene should represent a distinct investigative challenge, narrative beat, or significant interaction, even if it spans multiple physical rooms.

You are provided with:
1.  A list of **identified locations** from the adventure, along with their raw descriptive text.
2.  The **full raw adventure text** for additional context.

Your output should be a series of YAML blocks, one for each new scene. Each scene block MUST include:
* `scene_number`: A unique sequential number.
* `scene_title`: A descriptive title for the grouped scene.
* `location`: A **list** of the *exact names* of all identified locations (from the "Identified Locations" section below) that are part of this single scene. **CRITICAL: The location names in this list MUST ONLY come directly from the 'name' fields provided in the 'Identified Locations' section. You MUST NOT infer, generate, or use any location names that are not explicitly present in that list (e.g., from the raw adventure text).**
* `raw_adventure_text`: The concatenated raw text from the original adventure that pertains to ALL locations included in this scene. This is CRITICAL. Extract the exact text without modification.

## üí° Scene Cohesion Rules (CRITICAL)

‚ö†Ô∏è **Your primary directive is to create coherent, narrative scenes, NOT a room-by-room breakdown.**
**Think like a GM planning a session, not an architect drawing a floor plan.**

**Combine multiple of the identified locations into a single scene when they directly contribute to ONE primary objective or ritual AND are freely accessible.** This is paramount for SotS's investigative flow.

### **Explicit Grouping Rule:**

* **If a sequence of locations (e.g., Entry Hall, Sacristy, Vestry, Sanctuary) contains components for a SINGLE, CONTINUOUS RITUAL or a SHARED OBJECTIVE, these locations MUST be grouped into ONE scene.** The progression between them should be seamless and part of a larger narrative beat.
* **Identify the main objective/ritual.** All locations contributing to *that single objective* form one scene.
* **Crucially, if an 'Identified Location' `name` already represents such a pre-combined unit (e.g., 'Sacristy_Vestry_Sanctuary_Combined'), you MUST treat that named entry as a single, indivisible location for scene assignment. Do NOT split this pre-combined unit into multiple scenes, regardless of how many individual sections are described within its `description_text`.**

**Example Scenario (DO THIS!):**
* **Identified Locations:** "Entry Hall", "Sacristy", "Vestry", "Sanctuary"
* **Underlying Objective (Implicit or Explicit in text):** "Perform the Temple's Cleansing Ritual"
* **CORRECT SCENE GROUPING:**
    * **Scene Title:** "Temple Cleansing Ritual"
    * **Locations included:** Entry Hall, Sacristy, Vestry, Sanctuary
    * **Raw Text:** The full paragraphs describing all these locations and any related events.

### **Indicators for a NEW Scene (Only Split When These Apply, and Only if Not a Pre-Combined Location):**

* **These indicators apply primarily to individual locations that have NOT been pre-combined.** If an 'Identified Location' `name` represents a pre-combined group (like 'Sacristy_Vestry_Sanctuary_Combined'), **DO NOT** use these indicators to split that specific pre-combined group into multiple scenes, nor should you use its component names (e.g., 'Sacristy', 'Vestry') in other scenes.

* **MAJOR Obstacle/Barrier:** A physical or magical block that *must* be overcome to progress.
* **Significant Time Skip:** A clear narrative break.
* **New Primary Objective:** The core goal changes from the previous one.
* **Shift in Tone/Threat:** A sudden introduction of combat, a major social encounter, or a significant environmental hazard that dominates the new area.
* **Unrelated Investigative Thread:** Clues for a completely new mystery that doesn't tie into the current objective.

---

## üó∫Ô∏è Identified Locations

Here is the structured data for locations found in the adventure:
**IMPORTANT**: Some `name` entries below may represent a combination of multiple original locations (e.g., 'Sacristy_Vestry_Sanctuary_Combined'). When a `name` contains such a combined string, you **MUST** treat that entire entry as a single, indivisible location for the purpose of scene grouping. Do not split it into multiple scenes, even if its `description_text` describes distinct sub-areas or sequential activities.

```yaml
{{ identified_locations.strip() }}
```

---

üìö Full Raw Adventure Text for Context
Use this full text to accurately extract raw_adventure_text for each grouped scene. Only include text relevant to the locations in the current scene.

{{ full_adventure_text.strip() }}

---

üß© Output Format
Return multiple YAML blocks. Each block defines one grouped scene.

CRITICAL FORMATTING RULES:

- Each ````yamlblock ( yaml\n...\n `) must represent a single YAML document (i.e., one complete scene).
- DO NOT use --- within the content of a single ````yamlblock (i.e., betweenscene_number:andraw_adventure_text:` for one scene).
- You may separate multiple yaml` blocks with newlines or plain text. Do not explicitly use `---` as a top-level separator betweenyamlblocks unless you are providing additional prose, though it is not strictly necessary for parsing. The parser will find all ````yaml blocks.

```yaml
scene_number: 1
scene_title: The Temple Entry
location:
  - Entry Hall
raw_adventure_text: |
  The entry hall is dimly lit... (Exact text from original adventure, covering Entry Hall, Sacristy, Vestry descriptions and any events within them)
  A small, dusty room adjacent to the main hall...
  Connecting the sacristy to the sanctuary...
```

```yaml
scene_number: 2
scene_title: Altar Ritual
location:
  - Sacristy
  - Vestry
  - Sanctuary
raw_adventure_text: |
  The main chamber of the temple, dominated by a large, cracked altar... (Exact text for Sanctuary and Main Altar)
  The altar shows signs of recent use...
```

Repeat this block for each grouped scene. Ensure `raw_adventure_text` is accurate and complete for the locations in that scene.

